(function(a){a.fn.datesel=function(q){var h=a(this);if(!h.length){return false}q=a.extend({formatDate:"y-m-d",formatTime:"h:i",minuteStep:5,wrapTag:"span",wrapClass:"datesel-wrap",selectClass:"datesel-select form-control",week:true,weekName:new Array("日","月","火","水","木","金","土")},q);var h={},c=q.wrapTag,o=q.wrapClass,e=new Date(),p=e.getFullYear(),v=e.getMonth()+1,A=e.getDate(),x=e.getHours(),w=e.getMinutes(),H=p-3,m=p+1;var u=function(I,Q){if(!I||"string"!=typeof(I)){return false}I=I.replace(/[Ａ-Ｚａ-ｚ０-９－／　]/g,function(R){return String.fromCharCode(R.charCodeAt(0)-65248)});if(I.match(/^(2\d{3})([\/-]|年)$/)){var P=Number(RegExp.$1);var K=(!Q)?1:12;var N=(!Q)?1:(new Date(P,K,0)).getDate();return{date:(new Date(P,(K-1),N,0,0,0)),string:P+"/"+(("0"+K).slice(-2))+"/"+(("0"+K).slice(-2))}}else{if(I.match(/^(2\d{3})([\/-]|年)?(\d{1,2})([\/-]|月)?$/)){var P=Number(RegExp.$1);var K=Number(RegExp.$3);var N=(!Q)?1:(new Date(P,K,0)).getDate();return{date:(new Date(P,(K-1),N,0,0,0)),string:P+"/"+(("0"+K).slice(-2))+"/"+(("0"+K).slice(-2))}}}if(String(I)[0]=="1"&&(I.length==10||I.length==13)){I=(I.length==10)?Number(I+"000"):Number(I);J=new Date(I);yy=J.getFullYear();mm=("0"+(J.getMonth()+1)).slice(-2);dd=("0"+(J.getDate())).slice(-2);hh=("0"+(J.getHours())).slice(-2);ii=("0"+(J.getMinutes())).slice(-2);O=yy+"/"+mm+"/"+dd+" "+hh+":"+ii}else{if(r=I.match(/(2\d{3})([\/-]|年)?(\d{1,2})([\/-]|月)?(\d{1,2})/)){var P,K,N,M,L,J,O;P=Number(r[1]),K=Number(r[3]),N=Number(r[5]);if(K>=1&&K<=12&&N>=1&&N<=31){O=P+"/"+(("0"+K).slice(-2))+"/"+(("0"+N).slice(-2));if(r=I.match(/ ?(\d{1,2})(\:|時)(\d{1,2})/)){M=Number(r[1]),L=Number(r[3]);if(M>=0&&M<=24&&L>=0&&L<=59){O+=" "+(("0"+M).slice(-2))+":"+(("0"+L).slice(-2));J=(new Date(P,(K-1),N,M,L,0))}}else{O+=" 00:00";J=(new Date(P,(K-1),N,0,0,0))}}}}if(J){return{date:J,string:O}}return false};var D=(function(){var K='<select class="'+q.selectClass+'">';K+='<option value="">年</option>';for(var J=H,I=m;J<I;J++){K+='<option value="'+J+'">'+J+"年</option>"}K+="</select>";return a(K)})(),g=(function(){var K='<select class="'+q.selectClass+'">';K+='<option value="">月</option>';for(var J=1,I=12;J<I;J++){K+='<option value="'+J+'">'+((" "+J).slice(-2))+"月</option>"}K+="</select>";return a(K)})(),n=(function(){var L='<select class="'+q.selectClass+'">';L+='<option value="">日</option>';if(q.week&&q.weekName){var M=q.weekName;for(var K=1,J=(new Date(p,v,0)).getDate();K<=J;K++){var I=M[(new Date(p,v-1,K)).getDay()];L+='<option value="'+K+'">'+((" "+K).slice(-2))+"日("+I+")</option>"}}else{for(var K=1,J=(new Date(p,v,0)).getDate();K<=J;K++){L+='<option value="'+K+'">'+((" "+K).slice(-2))+"日</option>"}}L+="</select>";return a(L)})(),k=(function(){var K='<select class="'+q.selectClass+'">';K+='<option value="">時</option>';for(var J=0,I=23;J<=I;J++){K+='<option value="'+J+'">'+((" "+J).slice(-2))+"時</option>"}K+="</select>";return a(K)})(),j=(function(){var L=q.minuteStep,K='<select class="'+q.selectClass+'">';K+='<option value="">分</option>';for(var J=0,I=59;J<=I;J=J+L){K+='<option value="'+J+'">'+(("0"+J).slice(-2))+"分</option>"}K+="</select>";return a(K)})();var l=function(S,L){var Q,I,O,M,K,R,P="",J=S.data(),N={y:null,m:null,d:null,h:null,i:null};if(J.y){R=J.y.val();if(R){N.y=R;P+=R}}if(J.m){R=J.m.val();if(R){N.m=R;if(L&&N.y){P+=("0"+R).slice(-2)}}}if(J.d){R=J.d.val();if(R){N.d=R;if(L&&N.m){P+=("0"+R).slice(-2)}}}if(J.h){R=J.h.val();if(R){N.h=R}}if(J.i){R=J.i.val();if(R){N.i=R}}if(L){if(!P||P.length<8){return false}if(N.h){P+=("0"+N.h).slice(-2);if(N.i){P+=("0"+N.i).slice(-2)}}return Number(P)}else{return N}},d=function(K){var I,J,N=K.data(),O=l(K);for(J in O){if(O[J]){if(!I){I={}}if("y"==J){I[J]=O[J]}else{I[J]=(("0"+O[J]).slice(-2))}}}if(I&&I.y&&I.m&&I.d){var M=N.formatDate;var L=M.replace("y",I.y).replace("m",I.m).replace("d",I.d);if(N.formatTime&&I.h&&I.i){L+=" "+N.formatTime.replace("h",I.h).replace("i",I.i)}K.val(L)}else{K.val("")}};var t=function(S,L){var M,R,Q,O,J,P="",I=S.data("y");if(!L){L=I.val()}if(!S.data("min")){M=H}else{M=S.data("min").date.getFullYear()}if(!S.data("max")){R=m}else{R=S.data("max").date.getFullYear()}P+='<option value="">年</option>';for(var N=M,K=R;N<=K;N++){var T=(L==N?' selected="selected"':"");P+='<option value="'+N+'"'+T+">"+N+"年</option>"}I.html(P)},z=function(T,L){var M,R,O="",S,K,I=T.data("m"),P=l(T);if(!L){L=I.val()}if(!T.data("min")){M=1}else{S=T.data("min").date,K=S.getFullYear();if(P){if(P.y<K){M=13;L=null;I.val("");T.data("d").val("")}else{if(P.y==K){M=S.getMonth()+1}}}}if(!T.data("max")){R=12}else{S=T.data("max").date,K=S.getFullYear();if(P){if(P.y>K){R=0;L=null;I.val("");T.data("d").val("")}else{if(P.y==K){R=S.getMonth()+1}}}}O+='<option value="">月</option>';for(var N=1,J=12;N<=J;N++){var U=(L==N?' selected="selected"':"");var Q=(N<M||N>R?' disabled="disabled"':"");O+='<option value="'+N+'"'+U+Q+">"+((" "+N).slice(-2))+"月</option>"}I.html(O)},b=function(N,Q){var T,V,M="",aa,I,K,R=N.data("d"),S=l(N),X=31,P=p,Y=v;if(S){X=(new Date(S.y,S.m,0)).getDate();P=S.y;Y=S.m}if(!Q){Q=R.val()}if(Q>X){Q=X}if(!N.data("min")){T=1}else{aa=N.data("min").date,I=aa.getFullYear(),K=aa.getMonth()+1;if(S){if(S.y<I&&S.m<K){T=60;Q=null;R.val("")}else{if(S.y==I&&S.m==K){T=aa.getDate();if(S.d<T){Q=null;R.val("")}}}}}if(!N.data("max")){V=X}else{aa=N.data("max").date,I=aa.getFullYear(),K=aa.getMonth()+1;if(S){if(S.y>I&&S.m>K){V=60;Q=null;R.val("")}else{if(S.y==I&&S.m==K){V=aa.getDate();if(S.d>V){Q=null;R.val("")}}}}}M+='<option value="">日</option>';if(q.week&&q.weekName){var J=q.weekName;for(var W=1,U=X;W<=U;W++){var L=J[(new Date(P,Y-1,W)).getDay()];var O=(Q==W?' selected="selected"':"");var Z=(W<T||W>V?' disabled="disabled"':"");M+='<option value="'+W+'"'+O+Z+">"+((" "+W).slice(-2))+"日("+L+")</option>"}}else{for(var W=1,U=X;W<=U;W++){var O=(Q==W?' selected="selected"':"");var Z=(W<T||W>V?' disabled="disabled"':"");M+='<option value="'+W+'"'+O+Z+">"+((" "+W).slice(-2))+"日</option>"}}R.html(M)},F=function(O,R){var U=0,W=23,M="",S=O.data("h"),T=l(O,true),aa=(T?Number((""+T).substr(0,8)):null);if(!S){return false}if(!R){R=S.val()}if(O.data("min")){if(T){var Z=O.data("min").date,I=Z.getFullYear(),L=Z.getMonth()+1,Q=Z.getDate(),N=Z.getHours(),J=Number(I+(("0"+L).slice(-2))+(("0"+Q).slice(-2)));if(aa==J){U=N}else{if(aa<J){U=24;R=null}}}else{U=24;R=null}}if(O.data("max")){if(T){var Z=O.data("max").date,I=Z.getFullYear(),L=Z.getMonth()+1,Q=Z.getDate(),N=Z.getHours(),K=Number(I+(("0"+L).slice(-2))+(("0"+Q).slice(-2)));if(aa==K){W=N}else{if(aa>K){W=0;R=null}}}else{W=0;R=null}}M+='<option value="">時</option>';for(var X=0,V=23;X<=V;X++){var P=(R==X?' selected="selected"':"");var Y=(X<U||X>W?' disabled="disabled"':"");M+='<option value="'+X+'"'+P+Y+">"+((" "+X).slice(-2))+"時</option>"}S.html(M)},E=function(R,U){var Y=0,aa=59,O="",K=q.minuteStep,V=R.data("i"),W=l(R,true),M=(W?Number((""+W).substr(0,10)):null);if(!V){return false}if(!U){U=V.val()}if(R.data("min")){if(W){var ac=R.data("min").date,I=ac.getFullYear(),N=ac.getMonth()+1,T=ac.getDate(),Q=ac.getHours(),P=ac.getMinutes(),J=Number(I+(("0"+N).slice(-2))+(("0"+T).slice(-2))+(("0"+Q).slice(-2)));if(M==J){Y=P}else{if(M<J){Y=60;U=null}}}else{Y=60;U=null}}if(R.data("max")){if(W){var ac=R.data("max").date,I=ac.getFullYear(),N=ac.getMonth()+1,T=ac.getDate(),Q=ac.getHours(),P=ac.getMinutes(),L=Number(I+(("0"+N).slice(-2))+(("0"+T).slice(-2))+(("0"+Q).slice(-2)));if(M==L){aa=P}else{if(M>L){aa=0;U=null}}}else{aa=0;U=null}}O+='<option value="">分</option>';for(var Z=0,X=59;Z<=X;Z=Z+K){var S=(U==Z?' selected="selected"':"");var ab=(Z<Y||Z>aa?' disabled="disabled"':"");O+='<option value="'+Z+'"'+S+ab+">"+(("0"+Z).slice(-2))+"分</option>"}V.html(O)};var i=function(J,M){var L,K,I;if(J.data("minObj")){K=J.data("minObj");I=l(J);I.y=(I.y?I.y:m);I.m=(I.m?I.m:12);I.d=(I.d?I.d:31);I.h=(I.h?I.h:23);I.i=(I.i?I.i:59);K.data("max",u(I.y+"-"+I.m+"-"+I.d+" "+I.h+":"+I.i));I=l(K);I.y=(I.y?I.y:H);I.m=(I.m?I.m:"01");I.d=(I.d?I.d:"01");I.h=(I.h?I.h:"00");I.i=(I.i?I.i:"00");J.data("min",u(I.y+"-"+I.m+"-"+I.d+" "+I.h+":"+I.i))}else{if(J.data("maxObj")){K=J.data("maxObj");I=l(J);I.y=(I.y?I.y:H);I.m=(I.m?I.m:"01");I.d=(I.d?I.d:"01");I.h=(I.h?I.h:"00");I.i=(I.i?I.i:"00");K.data("min",u(I.y+"-"+I.m+"-"+I.d+" "+I.h+":"+I.i));I=l(K);I.y=(I.y?I.y:m);I.m=(I.m?I.m:12);I.d=(I.d?I.d:31);I.h=(I.h?I.h:23);I.i=(I.i?I.i:59);J.data("max",u(I.y+"-"+I.m+"-"+I.d+" "+I.h+":"+I.i))}}if(!M||(M&&!M.y)){t(J);if(K){t(K)}}if(!M||(M&&!M.m)){z(J);if(K){z(K)}}if(!M||(M&&!M.d)){b(J);if(K){b(K)}}if(!M||(M&&!M.h)){F(J);if(K){F(K)}}if(!M||(M&&!M.i)){E(J);if(K){E(K)}}d(J);if(K){d(K)}};var s=function(J){var I=a(J.target).data("target");i(I)},y=function(J){var I=a(J.target).data("target");i(I,{y:true})},G=function(J){var I=a(J.target).data("target");i(I,{y:true,m:true})},C=function(J){var I=a(J.target).data("target");i(I,{y:true,m:true,d:true})},B=function(J){var I=a(J.target).data("target");i(I,{y:true,m:true,d:true,h:true})};var f=a();h.each(function(){var O,K,I=a(this),J=a("<"+c+(o?' class="'+o+'"':"")+"/>"),P=(""+Math.random()).substr(2),N=I.data("time"),M={id:P,def:u(I.val()),min:I.data("min"),max:I.data("max"),minObj:null,maxObj:null,y:D.clone(true),m:g.clone(true),d:n.clone(true),formatDate:I.data("formatDate")||q.formatDate,formatTime:null};if(M.min){O=u(M.min);if(!O){M.minObj=M.min;M.min=null;f.push(I)}else{M.min=O}}if(M.max){O=u(M.max);if(!O){M.maxObj=M.max;M.max=null;f.push(I)}else{M.max=O}}if(I.data("formatTime")){M.formatTime=I.data("formatTime")}else{if(N){M.formatTime=q.formatTime}}if(N){M.h=k.clone(true);M.i=j.clone(true);J.append(M.y).append(M.m).append(M.d).append(M.h).append(M.i)}else{J.append(M.y).append(M.m).append(M.d)}M.y.on("change",s).data({target:I});M.m.on("change",y).data({target:I});M.d.on("change",G).data({target:I});if(N){M.h.on("change",C).data({target:I});M.i.on("change",B).data({target:I})}if(M.def){var L=M.def.date;M.y.val(L.getFullYear());M.m.val(L.getMonth()+1);M.d.val(L.getDate());if(N){M.h.val(L.getHours());M.i.val(L.getMinutes())}}I.data(M);t(I);z(I);b(I);if(N){F(I);E(I)}I.after(J)});if(f.length){f.each(function(J){var I=this,L=I.data(),K;if("string"==typeof L.minObj){K=h.filter(L.minObj).first();if(K.length){I.data("minObj",K);K.data("maxObj",I);i(I)}else{I.data("minObj",null);K.data("maxObj",null)}}else{if("string"==typeof L.maxObj){K=f.filter(L.maxObj);if(K.length){I.data("maxObj",K);K.data("minObj",I);i(I)}else{I.data("maxObj",null);K.data("minObj",null)}}}})}}})(jQuery);